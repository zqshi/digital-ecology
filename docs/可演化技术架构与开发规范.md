# 可演化技术架构与开发规范（v1）

## 1. 目的与适用范围

本文用于指导“生态社会系统”的工程落地，优先解决：
- 顶层可演化技术架构如何设计。
- 技术栈如何选型与分阶段演进。
- 开发规范如何保证协同、健壮与可扩展。
- 项目文件结构、代码规模、文档边界如何约束。

硬约束：
- 自举循环是手段，不是目标。任何自举实现不得偏离“构建数字生态系统”的主目标。

适用对象：架构组、平台组、治理组、风控组、交付组、数据组。

---

## 2. 顶层可演化技术架构

### 2.1 架构原则
- 可替换：关键组件可插拔，不绑定单一模型厂商或单一中间件。
- 可回滚：所有策略、流程、模型升级必须具备自动回滚链路。
- 可观测：关键行为必须事件化、可追溯、可审计。
- 可分区：Open/Work/Quarantine 三域强隔离，权限与预算分治。
- 可演化：策略、制度、协作流程可版本化管理并灰度发布。

### 2.2 逻辑分层（四平面）
1. 治理平面（Governance Plane）
- 宪法规则、策略引擎、提案表决、仲裁与复核。

2. 控制平面（Control Plane）
- 身份、权限、接入、任务编排、预算分配、升级闸门。

3. 执行平面（Execution Plane）
- Agent Runtime、工具调用、任务执行、结果合成。

4. 数据平面（Data Plane）
- 事件总线、审计存储、记忆库、知识图谱、指标仓库。

### 2.3 关键架构能力（必须先落）
- Mission Broker：人类任务受理、分解、分配、交付编排。
- Evolution Service：候选改进生成、实验编排、灰度与固化。
- Archaeology Service：开源“化石层”采集、模式挖掘、制度模板化。
- Policy Decision/Enforcement：实时策略判定与执行。
- Audit Backbone：不可篡改事件链和证据包生成。

---

## 3. 技术栈建议（分阶段）

## 3.1 语言与框架
- 控制面/治理面：`TypeScript (Node.js)` + `NestJS`。
- 数据与演化分析：`Python`（特征提取、模式挖掘、实验分析）。
- 高性能服务（可选，后续阶段）：`Go`（事件消费、预算结算高并发路径）。

选择理由：
- TS 统一 API 和工程规范，适合多团队协作。
- Python 生态适合数据/策略/考古分析。
- Go 作为性能兜底，不在初期增加复杂度。

## 3.2 存储与消息
- 主事务库：`PostgreSQL`（身份、契约、任务、治理、结算）。
- 缓存：`Redis`（任务队列状态、限流令牌、短期上下文）。
- 事件总线：`Kafka`（或 Redpanda）用于事件化架构。
- 审计仓：`Object Storage + WORM策略`（不可篡改审计）。
- 向量库：`pgvector`（早期）-> 独立向量库（中后期）。
- 图数据库（可选中后期）：`Neo4j`（谱系、关系与反例图谱）。

## 3.3 编排与运行
- 容器：`Docker`。
- 编排：`Kubernetes`（开发阶段可先单机 compose）。
- 工作流：`Temporal`（任务状态机、重试、补偿、SLA追踪）。
- API 网关：`Envoy`/`Kong`（鉴权、限流、审计钩子）。

## 3.4 策略与安全
- 策略引擎：`OPA (Open Policy Agent)`。
- 密钥与密文：`Vault`。
- 身份认证：`OIDC` + service account。
- 零信任：默认拒绝，按任务临时授权。

## 3.5 可观测性
- 指标：`Prometheus`。
- 日志：`OpenSearch`/`Loki`。
- 链路追踪：`OpenTelemetry + Jaeger`。
- 告警：`Alertmanager` + 值班轮值策略。

---

## 4. 参考仓库与项目文件组织结构

建议使用单仓多包（Monorepo），统一规范与版本管理：

```text
/ecology
  /apps
    /control-plane-api          # 身份/权限/接入/任务编排 API
    /governance-api             # 提案/投票/仲裁/制度发布 API
    /mission-broker             # 人类任务分解、调度、交付聚合
    /evolution-engine           # 演化实验、灰度、固化
    /archaeology-engine         # 开源化石采集、模式挖掘、模板输出
    /runtime-gateway            # Agent 运行接入网关
    /audit-writer               # 审计事件标准化写入
  /services
    /policy-pdp                 # OPA 策略决策适配层
    /policy-pep                 # 网关策略执行层
    /settlement-engine          # 结算与保证金/追偿
    /reputation-engine          # 信誉模型与修复机制
    /incident-orchestrator      # L3/L4 事件处置编排
  /workers
    /task-dispatcher
    /sla-monitor
    /rollback-worker
    /evidence-pack-builder
  /libs
    /domain-models              # 领域模型与 DTO
    /event-schemas              # 事件协议（版本化）
    /policy-contracts           # 策略输入输出契约
    /sdk-agent                  # Agent 接入 SDK
    /sdk-human-mission          # 人类任务提交 SDK
    /observability-kit
  /infra
    /k8s
    /terraform
    /helm
    /opa-policies
  /data
    /migrations
    /seeds
    /archaeology-datasets
  /docs
    /adr                         # 架构决策记录
    /rfc                         # 机制变更提案
    /runbooks                    # 运行与应急手册
    /specs                       # 协议、API、事件规范
  /tests
    /contract
    /integration
    /e2e
    /chaos
```

---

## 5. 开发规范（Engineering Contract）

## 5.1 分支与版本
- 分支策略：`main`（稳定）+ `codex/*`（特性分支）。
- 版本策略：语义化版本 + 策略版本 + 事件Schema版本三轨并行。
- 强制规则：任何跨服务变更必须附带Schema迁移计划。

## 5.2 代码规范
- 必须启用：lint、format、type-check、单测门禁。
- 禁止：绕过策略引擎直连执行平面；绕过审计写入关键动作。
- 必须：关键路径函数写“失败补偿逻辑”与“幂等处理”。

## 5.3 测试规范
- 单测覆盖：核心域服务 >= 80%。
- 契约测试：所有跨服务 API/事件必有契约测试。
- 集成测试：任务受理 -> 分配 -> 交付 -> 验收 -> 结算全链路。
- 混沌测试：每月一次（消息延迟、节点故障、回滚失败场景）。

## 5.4 发布规范
- 发布路径：沙盒 -> 小流量灰度 -> 全量。
- 回滚条件：发布前定义，发布后自动检测触发。
- 变更记录：必须生成 Evidence Pack（变更理由、范围、风险、回滚结果）。

## 5.5 安全与合规规范
- 所有敏感字段加密存储。
- 所有高风险动作双重授权。
- 所有交付包可追溯到责任主体与证据链。
- 所有自治执行必须遵循运行模式协议（AUTO/SUPERVISED/LOCKDOWN）。

---

## 6. 文档规范与代码规模约束

## 6.1 文档分层
- L0：宪法与治理规则（不可频繁变）。
- L1：架构与机制（季度迭代）。
- L2：协议与接口（版本化、变更可追踪）。
- L3：运行手册与应急流程（持续更新）。

## 6.2 文档最低交付标准
每个服务上线前必须具备：
1. 设计文档（目标、边界、依赖、失败模式）。
2. API/事件规范（含版本与兼容策略）。
3. Runbook（常见故障、排障命令、回滚步骤）。
4. SLO 与告警定义。

## 6.3 文档与代码量建议
- 代码与文档建议比：`1000 LOC : 100~200 行核心文档`（不含自动生成文档）。
- 每个服务 ADR：最少 1 篇（关键选型必须有 ADR）。
- 每个季度必须完成文档债务清理，文档过期率目标 < 10%。

说明：
- 不鼓励追求绝对代码量；以“可维护复杂度”作为主要约束。
- 复杂机制优先拆分为小服务，单服务建议不超过 `8k~12k LOC` 核心逻辑。

---

## 7. 实现边界（Scope Boundary）

## 7.1 必做（MVP到P1）
- 身份、权限、审计、契约结算、风险隔离、任务受托交付。
- 升级闸门、自动回滚、证据包生成。
- 自主预算池与被动化检测。
- 自举循环（bootstrap loop）在约束内自动生成内部改进任务。

## 7.2 延后（P2以后）
- 复杂跨域联邦互认。
- 全自动制度提案生成与自动立法。
- 大规模实时图计算与全域知识图谱联动。

## 7.3 禁止（当前阶段）
- 无审计关键动作。
- 无责任主体的版本分叉与发布。
- 未经沙盒/灰度直接修改生产治理规则。

---

## 8. 可扩展性设计要点

- 事件优先：所有跨域协作通过事件驱动，避免强耦合 RPC。
- 多租户隔离：租户、组织、主体三级隔离模型。
- 读写分离：治理写路径与分析读路径分离。
- 能力插件化：Agent 能力声明标准化，运行时按插件装配。
- Schema 兼容：事件协议前向/后向兼容，提供版本转换器。

---

## 9. 技术决策清单（开工前拍板）

1. 工作流引擎是否采用 Temporal 作为标准编排内核。
2. 事件总线选型（Kafka/Redpanda）与数据保留周期。
3. 审计存储WORM方案与证据包归档周期。
4. OPA策略仓如何分层（全局/域/任务级）。
5. Mission Broker 与 Evolution Service 的边界是否独立部署。
6. Archaeology 数据采集合规边界（采集范围、频率、匿名化规则）。

---

## 10. 里程碑与交付物（建议）

### M1（0-6周）
- 交付：控制平面最小集 + 审计主干 + 任务受理与契约闭环。
- 出口条件：人类任务可下发并完成一次可审计交付。

### M2（7-12周）
- 交付：升级闸门、自动回滚、风险分级与隔离。
- 出口条件：L3 事件可在SLA内自动隔离并复盘。

### M3（13-20周）
- 交付：演化服务 + 自主预算 + 被动化修复流程。
- 出口条件：自主进化指标稳定达标。
- 交付：bootstrap-loop 与信号驱动任务自举机制上线。

### M4（21-28周）
- 交付：数字考古管线 + 制度模板注册与验证闭环。
- 出口条件：至少一项制度基于考古证据包生效。

---

## 11. 一句话结论

顶层可演化技术架构的核心不是“堆栈先进”，而是：
在可替换、可回滚、可审计、可分区的工程约束下，让“人类任务交付 + 自主演化 + 制度进化”三条主线长期协同运行。

---

## 12. 执行入口

- M1 工程初始化清单：`/Users/zqs/Downloads/project/digital ecology/docs/M1工程初始化清单.md`
- 自治运行模式协议：`/Users/zqs/Downloads/project/digital ecology/docs/specs/autonomy-operation-mode-v1.md`
